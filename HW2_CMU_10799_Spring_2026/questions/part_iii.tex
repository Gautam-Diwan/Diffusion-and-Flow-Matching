\hwpart{III}{Implement DDIM (20 points)}

So far you've trained two generative models: DDPM (HW1) and Flow Matching (this homework). You may have noticed that DDPM requires many more sampling steps ($\sim$1000) compared to Flow Matching ($\sim$100) to produce good results. Can we make DDPM faster without retraining?

DDIM (Denoising Diffusion Implicit Models)~\citep{song2020denoising} answers this question. The key insight is that DDPM's reverse process can be generalized to a family of non-Markovian processes that share the same training objective. By setting the stochasticity to zero, we get a deterministic ODE that can be solved with far fewer steps â€” using the exact same trained model.

The DDIM update rule is:
\begin{equation}
    x_{t-1} = \sqrt{\bar{\alpha}_{t-1}} \underbrace{\left( \frac{x_t - \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon_\theta(x_t, t)}{\sqrt{\bar{\alpha}_t}} \right)}_{\hat{x}_0} + \sqrt{1 - \bar{\alpha}_{t-1}} \cdot \epsilon_\theta(x_t, t)
\end{equation}

Or in pseudocode:

\begin{algorithm}[H]
\caption{DDIM Sampling}
\begin{algorithmic}[1]
\Require trained noise predictor $\epsilon_\theta$, number of steps $S$, noise schedules $\bar{\alpha}$
\State Sample $x_T \sim \mathcal{N}(0, I)$
\State Create timestep subsequence $[\tau_S, \tau_{S-1}, ..., \tau_1]$ from $[T, ..., 1]$ \Comment{e.g., $[1000, 900, 800, ...]$}
\For{$i = S, S-1, ..., 1$}
    \State $t \gets \tau_i$
    \State $t_{\text{prev}} \gets \tau_{i-1}$ (or $0$ if $i = 1$)
    \State $\epsilon \gets \epsilon_\theta(x_t, t)$ \Comment{Predict noise using your trained DDPM}
    \State $\hat{x}_0 \gets \frac{x_t - \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon}{\sqrt{\bar{\alpha}_t}}$ \Comment{Predict clean image}
    \State $x_{t_{\text{prev}}} \gets \sqrt{\bar{\alpha}_{t_{\text{prev}}}} \cdot \hat{x}_0 + \sqrt{1 - \bar{\alpha}_{t_{\text{prev}}}} \cdot \epsilon$ \Comment{DDIM step}
\EndFor
\State \Return $x_0$
\end{algorithmic}
\end{algorithm}

\question{DDIM Implementation}{20}

Implement DDIM sampling for DDPM model that you trained for HW1. No retraining needed! DDIM works with your existing trained model!

\subq{a}{10} Generate a grid of 16 samples using 100 DDIM steps and include it below.

\answerbox{}{
% Your answer here
\vspace{9cm} % comment this line out after you put in your answers
}
\includeanswer{q6a}

\subq{b}{10} Evaluate KID with 1k samples using 100 DDIM steps. Report your KID score (mean and std). How does this compare to your original DDPM with 1000 steps and your Flow Matching model?

\answerbox{}{
% Your answer here
\vspace{1cm} % comment this line out after you put in your answers
}
\includeanswer{q6b}